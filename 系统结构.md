## 流水线技术

流水线把一个处理过程分解为若干个子过程(段),每个子过程由一个专门的功能部件来实现。

时间最长的段将成为流水线的瓶颈。

流水线每一个段的后面都要有一个缓冲寄存器(锁存器),称为流水寄存器。

作用:在相邻的两段之间传送数据，以保证提供后面要用到的信息，并把各段的处理工作相互隔离。

通过时间:第一个任务从进入流水线到流出结果
所需的时间。

排空时间:最后一个任务从进入流水线到流出结
果所需的时间。

### 流水线冲突

## 互连网络

针对于集群或者计算机内部的链接。

由开关原件按照一定拓扑结构和控制方式构成的网络。

操作方式：

1. 同步

2. 异步

交换方式：

1. 电路交换L物理通路在数据传送之间保持连接

2. 分组交换：消息奉承包，送入互连网络

3. 蠕虫(wormhole)交换：打成多个段

### 静态网络

链路无源

开关元件通过处理器链接

不直接相连的通信需要通过中间节点中转。

链接方式不会改变

#### 指标

1. 节点度：入度+出度

2. 距离：两个节点之间相连的最少边数

3. 【考点】网络直径：网络中任意两个节点距离的最大值

4. 网络规模：节点数

5. 等分宽度：（节点数差值$\le 1$）切口的最小边数称为等分宽度。

6. 对称性：从任何节点看，拓扑结构都一样，这样的网络实现是容易的。

7. 节点是否同构。

8. 通道是否有缓冲。

#### 典型静态网络

1. 线性阵列。

N个节点，N-1个链路，直径是N-1，度为2（不考虑边缘的度为1）。

N很大时，通信效率低。

* 总线：总线是独占的，而线性阵列允许同时通信。

2. 环。

单项环：

双向环：直径$[\frac{N}{2}]$。因为可以向左/向右走，走最短的那条。

3. 带弦环

环上面链接了弦。

链路数：点数乘以度数除以2.

4. 全联通（链接）

带弦环的特殊情况。

5. 树形

由于节点度为常数，所以树是一个可扩展的系统。

完全二叉树$N = 2^K - 1$

直径$2(K-1)$

一个问题是根结点负担太重：环形树，二叉胖树（度在变化，不好）

6. 星形

实际上是一个二层树。

N-1条链路，直径是2，不对称，等分宽度$[\frac{N}{2}]$。

7. 网格形

N个节点的$r\times r$网格。

有$2(N-r)$条链路，是行和列加起来。

直径是$2(r-1)$，左上到右下。

非对称，等分宽度偶数是r，奇数是r+1。

扩展：Illiac 网络

一个度为4的带弦环

2N条链路，直径是r-1，节点度为4

扩展：环形网络

直径$2[\frac{r}{2}]$，节点度4，对称。

8. 超立方体

N-立方体有$2^N$个节点

9. 带环超立方体

10. k元n-立方体

每一面是一个$k \times k$的环形网络。

K进制的数可以用来表示地址。

传统环型网络等于4元2-立方体。

### 动态网络

【不需要死记硬背具体的数字】

1. 恒等函数

2. 方体函数

$cube_k$表示把第k位的二进制数取反。

3. 洗牌函数

循环左移。

变形：均匀洗牌

洗牌函数和$cube_0$的结合。

变形：子洗牌（最低的k+1位循环左移）

变形：超洗牌（高位的k-1位循环左移）

4. 逆洗牌

循环右移。

5. 蝶式

最高位和最低位互换。

6. PM2I函数（加减$2^i$）

加的时候：加$2^i$后取模。

从左向右排列，遇到括号回来。

#### 多级互联网络

直送，上播，下播……

级间互联模式。

级控制：没级只有一个控制信号：最简单

每一个开关一个控制：最灵活

部分级控制：几个开关合用一个控制函数。

修改每一个按钮的状态，但是不能改显得状态。

1. $\Omega$网络：洗牌网络加上恒等网络。

并不是所有的置换都可以一次通过。

出现阻塞的时候，可以采用几次通过的方式。

可以实现广播。

3. 蝶式网络，不允许广播

### 通信问题

#### 基本指标

1. 消息分成多个包，每一个包若干个片。

3. 传输延迟

一个小气的和一个网路的

吞吐量：单位时间内，网络传输的消息量。

4. 传输延迟的公式

建立延迟 + 网络延迟 + 阻塞延迟

* 建立：和机器本身的技术有关。可以分为源节点和目的节点延迟。

* 网络：$T_p \times D + \frac{L}{B}$

节点延迟 + 线路延迟

D：中间节点数

$\frac{L}{B}$线路时延。

#### 路由算法

最短路/非最短路

确定性/非确定性

1. 存储转发

A把整个消息存储下来。

缺点是对于内存需求较大，而且

2. 虚拟直通

消息来一点，就开始进行路由选择。

$\frac{L_h D + L}{B}$

当统辖下一个节点的通道忙，或者是节点缓冲器非空闲时，退化到存储转发。

3. 线路开关/线路交换



4. wormhole交换

## Overview of Computer Architecture

这几的内容：计算、存储、网络

- 基础知识

- 最新进展

- 科研方法

* 几点经验和方法

- 短板理论

- 时尚没有万能药

## 流水线动态调度算法

RAW（写后读）的处理方法

1. Flush，等到写完了再读。

2. 看一下写缓冲区里是否有读的内容，如果没有那就不用等了。

3. 发现写缓冲区里面有，那么就直接进行转发，直接取内容，不用等。

（cache块中被替换出去，进行写）

流水线：顺序发射顺序执行。如果当前发生了冲突，他后面的指令也会停顿，此时的影响面很广。

分布式动态调度技术：tomasulo算法

### 指令级别并行

* 指令级别并行：

* 理想CPI加上各类停顿的时钟周期数。

* 理想CPI是衡量流水线最高性能的指标。

* 静态调度：依靠编译器进行静态调度，将可能引起冲突的语句分开。

* 动态调度：在程序的执行过程中，依靠专门的硬件对代码进行调度。


## Ch-12 多核Cache一致性

定义：同一个数据项在多个Cache和内存中不一致

### 引起不一致的因素

1. 写直达Cache的不一致

一个处理器更新了自己的cache和memory，但是旧的拷贝仍然存在在另一个处理器的cache中。

2. 写回的不一致

Proc 0: Update Cache。

Memory & Proc 1's Cache is outdated.

3. IO不一致

DMA（Direct Memory Access）修改了值，但是处理器的cache没有被更新。

### 一致性协议的设计思想

1. 没有处理器可以载入一个过时的数据：写入之后立刻更新或者无效化一些数据

2. 同一时刻只允许一个处理器写一个位置。（写序列化）

#### 什么时候应该通知其他的数据拷贝？

Cache State: Valid & Invalid

Op: Load & Store

Load Valid: not notify

Load Invalid: notify memory to fetch new data

Store Valid: notify other proccessors to invalidate or update

Store Invalid: notify others to return data and invalidate or update. （因为产生了一个更新的值）

#### 什么时候应该无效化其他拷贝？

1. Write invalidate:

写入共享数据：无效化其他

写直达：memory永远是最新的

写回：无效化内存中的数据

- 优点：对于一个处理器连续读写数据很好

2. Write update（broadcast）:

写入共享数据：更新其他

写直达：memory永远是最新的

- 优点：多个处理器同时读，写较少时性能好

#### 向谁发送请求？

1. Bus Snooping Protocol

对所有处理器发送请求

处理器监听是否有一个自己持有的copy需要被无效化和更新。

在小规模的机器上十分流行。

2. 基于目录的协议

分布式的目录。

通过点对点请求（网络结构）来通知对方处理器。

3. Token Protocol

每一个内存块被赋予了一些令牌。例如如果有T个processor，那么就有T个令牌。

当processor读的时候：它拿走内存块的一个令牌，读完了以后，它返回令牌。

当processor写的时候：它拿走内存块所有的令牌，写完了以后返回令牌。

当因为令牌个数不足没有办法读写的时候，产生一个request timeout，并提交一个永久请求。永久请求会被FIFO地解决和仲裁。

- 优点：可以和基于目录的协议中一样的一个没有方向网络，拥有和监听协议一样的低延时

### 监听协议的状态机

1. CPU本身对于已经在cache块内的数据进行读写

2. CPU本身对于不在cache块中的数据进行读写（首先进行了块替换）

3. 监听BUS信号对于cache数据的读写

### 目录协议的状态机

存储器、目录和cache处理器都是分布式的。

本地节点：发出请求的节点

宿主节点：包含所访问的存储单元与其目录的节点

袁成杰点：